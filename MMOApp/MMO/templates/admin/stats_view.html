{% extends 'admin/base_site.html' %}

{% block content %}
<div class="stats-container">
    <h1>üìä Th·ªëng k√™ ƒë·ªô uy t√≠n Store</h1>

    <!-- Form l·ªçc -->
    <form method="get" class="filter-form">
        <label>M√£ Store:
            <input type="text" name="store_code" value="{{ store_code }}">
        </label>
        <label>T·ª´:
            <input type="date" name="from" value="{{ date_from }}">
        </label>
        <label>ƒê·∫øn:
            <input type="date" name="to" value="{{ date_to }}">
        </label>
        <button type="submit">L·ªçc</button>
    </form>

    {% if store %}
    <h2>K·∫øt qu·∫£ cho Store: {{ store.name }} ({{ store.pk }})</h2>

    <!-- Cards ch·ªâ s·ªë -->
    <div class="cards">
        <div class="card">T·ªïng ƒë∆°n: {{ total_orders }}</div>
        <div class="card">Ho√†n t·∫•t: {{ completed_orders }}</div>
        <div class="card">Ho√†n ti·ªÅn: {{ refunded_orders }}</div>
        <div class="card">B·ªã khi·∫øu n·∫°i: {{ complained_orders }}</div>
        <div class="card">‚≠ê Rating TB: {{ avg_rating }}</div>
        <div class="card">‚è± TB giao h√†ng:
            {% if avg_delivery_hours %}{{ avg_delivery_hours }} gi·ªù{% else %}N/A{% endif %}
        </div>
        <div class="card">T·ªâ l·ªá ho√†n t·∫•t: {{ fulfill_rate_pct }}%</div>
        <div class="card">T·ªâ l·ªá khi·∫øu n·∫°i: {{ complaint_rate_pct }}%</div>
        <div class="card">T·ªâ l·ªá ho√†n ti·ªÅn: {{ refund_rate_pct }}%</div>
        <div class="card">üí∞ Doanh thu: {{ revenue_total }}</div>
    </div>

    <!-- ƒêi·ªÉm uy t√≠n -->
    <div class="score-container">
        <h3>ƒêi·ªÉm uy t√≠n: {{ reputation_score }}/100</h3>
        <div class="progress">
            <div class="progress-bar" style="width: {{ reputation_score }}%"></div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="charts">
        <canvas id="ordersChart"></canvas>
        <canvas id="revenueChart"></canvas>
        <canvas id="ratingChart"></canvas>
    </div>
    {% endif %}
</div>

<!-- Th√™m Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ labels|safe }};
    const orderCounts = {{ order_counts|safe }};
    const ratingLabels = {{ rating_labels|safe }};
    const ratingValues = {{ rating_values|safe }};
    const revenueValues = {{ revenue_values|default:"[]"|safe }};

    if (labels.length) {
        new Chart(document.getElementById('ordersChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'S·ªë ƒë∆°n h√†ng theo ng√†y',
                    data: orderCounts,
                    borderColor: 'blue',
                    backgroundColor: 'lightblue',
                    tension: 0.3
                }]
            }
        });
    }

    if (ratingLabels.length) {
        new Chart(document.getElementById('ratingChart'), {
            type: 'bar',
            data: {
                labels: ratingLabels,
                datasets: [{
                    label: 'Rating trung b√¨nh theo ng√†y',
                    data: ratingValues,
                    backgroundColor: 'orange'
                }]
            },
            options: {
                scales: {
                    y: { min: 0, max: 5, ticks: { stepSize: 1 } }
                }
            }
        });
    }

    if (labels.length && revenueValues.length) {
        new Chart(document.getElementById('revenueChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu theo ng√†y',
                    data: revenueValues,
                    borderColor: 'green',
                    backgroundColor: 'lightgreen',
                    tension: 0.3
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + ' ƒë';
                            }
                        }
                    }
                }
            }
        });
    }
</script>

<style>
    .stats-container {
        padding: 20px;
    }
    .filter-form {
        margin-bottom: 20px;
    }
    .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    .card {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
    }
    .score-container {
        margin-bottom: 20px;
    }
    .progress {
        width: 100%;
        background: #ddd;
        height: 20px;
        border-radius: 10px;
    }
    .progress-bar {
        height: 100%;
        background: green;
        border-radius: 10px;
    }
    .charts {
        display: grid;
        grid-template-columns: 1fr; /* ch·ªâ 1 c·ªôt */
        gap: 20px;
    }
</style>
{% endblock %}
